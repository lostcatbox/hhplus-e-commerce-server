# Kafka 기초 개념 및 구성 요소

## 1. Kafka란?

Apache Kafka는 **분산 스트리밍 플랫폼**으로, 대용량의 실시간 데이터를 안정적으로 처리하기 위한 메시징 시스템입니다.

### 1.1 Kafka의 주요 특징

- **높은 처리량**: 초당 수백만 개의 메시지 처리 가능
- **확장성**: 수평적 확장을 통한 처리량 증대
- **내구성**: 디스크에 메시지를 저장하여 데이터 손실 방지
- **분산 처리**: 여러 서버에 걸쳐 데이터를 분산 저장 및 처리
- **실시간 처리**: 낮은 지연시간으로 실시간 데이터 스트리밍

### 1.2 왜 대용량 시스템에서 Kafka를 사용하는가?

1. **비동기 처리**: 서비스 간 결합도를 낮추고 응답성 향상
2. **장애 격리**: 한 서비스의 장애가 다른 서비스에 전파되지 않음
3. **확장성**: 트래픽 증가에 따른 유연한 확장 가능
4. **데이터 복제**: 여러 Consumer가 동일한 데이터를 소비 가능
5. **순서 보장**: 파티션 내에서 메시지 순서 보장

## 2. Kafka 구성 요소

### 2.1 Producer
- 메시지를 Kafka 브로커에 발행(Publish)하는 클라이언트
- 메시지를 특정 토픽의 파티션에 전송
- 메시지 키를 통해 파티션 결정 가능

### 2.2 Consumer
- Kafka 브로커에서 메시지를 소비(Consume)하는 클라이언트
- Consumer Group을 통해 여러 Consumer가 협력하여 메시지 처리
- Offset을 통해 처리한 메시지 위치 추적

### 2.3 Broker
- Kafka 서버의 기본 단위
- Producer로부터 메시지를 받아 디스크에 저장
- Consumer의 요청에 응답하여 메시지 전송
- 클러스터 내에서 특별한 역할을 하는 브로커들:
  - **Controller**: 브로커 모니터링 및 Leader 파티션 재분배
  - **Coordinator**: Consumer Group 모니터링 및 Rebalancing

### 2.4 Topic & Partition
- **Topic**: 메시지를 분류하는 논리적 단위
- **Partition**: Topic을 물리적으로 분할한 단위
  - 메시지는 파티션 내에서 순서 보장
  - 파티션 수만큼 병렬 처리 가능
  - 메시지 키의 해시값으로 파티션 결정

```
key: "user123"
hash: 45678
partitionCount: 3
targetPartition: 45678 % 3 = 0
```

### 2.5 Consumer Group
- 하나의 토픽을 여러 서비스가 소비하기 위한 그룹
- 같은 그룹 내 Consumer들은 파티션을 분담하여 처리
- 하나의 파티션은 그룹 내 하나의 Consumer만 처리 가능

### 2.6 Rebalancing
- Consumer Group 내 Consumer 변화 시 파티션 재분배
- 발생 조건:
  1. Consumer 추가/제거
  2. Consumer 장애
  3. 파티션 추가
- 주의: Rebalancing 중에는 메시지 소비 중단

### 2.7 Cluster & Replication
- **Cluster**: 여러 브로커를 묶어 고가용성 확보
- **Replication**: 파티션 복제를 통한 장애 대응
  - **Leader Replica**: 모든 읽기/쓰기 요청 처리
  - **Follower Replica**: Leader의 데이터 복제 및 백업

## 3. Kafka 메시지 흐름

```
Producer → Topic(Partition) → Consumer
    ↓
1. 메시지 키 해싱으로 파티션 결정
2. 파티션에 순차적으로 메시지 저장
3. Consumer가 Offset 기반으로 메시지 소비
4. Consumer Group 내에서 파티션별 분담 처리
```

## 4. Kafka vs 기존 메시징 시스템

| 특징 | Kafka | 기존 메시징 시스템 |
|------|-------|------------------|
| 처리량 | 매우 높음 | 보통 |
| 지연시간 | 낮음 | 매우 낮음 |
| 순서 보장 | 파티션 내 보장 | 전체 보장 |
| 확장성 | 수평 확장 용이 | 제한적 |
| 내구성 | 디스크 저장 | 메모리 기반 |
| 복잡성 | 높음 | 낮음 |

## 5. 주의사항

- **비동기 메시지 통신 시 주의점**: 이벤트 발행 실패 시 전체 비즈니스 흐름에 문제 발생 가능
- **파티션 수 설계**: Consumer 수보다 파티션이 적으면 일부 Consumer가 유휴 상태
- **메시지 키 설계**: 적절한 키 설계로 파티션 간 부하 분산 필요
- **Offset 관리**: Consumer 장애 시 중복 처리 또는 메시지 누락 방지 필요 