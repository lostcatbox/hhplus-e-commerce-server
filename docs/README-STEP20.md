# Step 20: 부하 테스트 수행 및 장애 분석 문서

## 1. 개요

본 문서는 e-commerce 플랫폼에 대한 부하 테스트 수행 결과와 발견된 문제점들, 그리고 이에 대한 분석 및 개선안을 정리한 장애 분석 및 대응 문서입니다.

## 2. 부하 테스트 시나리오

### 2.1 테스트 환경
- **테스트 도구**: k6
- **테스트 대상**: 주문 처리 API (`POST /v1/orders`)
- **테스트 duration**: 1분
- **목표 TPS**: 50 TPS
- **최대 동시 사용자**: 31 VUs

### 2.2 테스트 시나리오
```javascript
// 주문 생성 시나리오
- 사용자별 포인트 충전 (100,000원)
- 상품 주문 (productId: 1-5 범위)
- 응답 시간 및 성공률 측정
```

## 3. 부하 테스트 결과 분석

### 3.1 성능 메트릭 결과
```
✅ 성공한 지표들:
- 테스트 지속 시간: 1분 0.7초 (목표: 1분)
- 총 요청 수: 3,001건
- 실제 처리량: 49.4 TPS (목표: 50 TPS)
- 평균 응답 시간: 17ms
- 95th percentile: 42ms (임계값: <1000ms)
- 99th percentile: 268ms (임계값: <2000ms)

❌ 실패한 지표들:
- 요청 성공률: 0.04% (99.96% 실패)
```

### 3.2 응답 시간 분석
시스템의 응답 시간 성능은 **매우 우수**한 수준을 보였습니다:
- 평균 응답 시간 17ms는 일반적인 웹 서비스 기준(100ms 이하)을 크게 상회
- 95th percentile 42ms로 대부분의 요청이 빠르게 처리
- 99th percentile 268ms로 극소수의 느린 요청도 허용 범위 내

## 4. 발견된 주요 장애 및 문제점

### 4.1 Critical Issues

#### 4.1.1 상품 데이터 부재 문제
**문제**: "Product를 찾을수없다고 뜬다" - 99.96% 실패율의 주요 원인
```
오류 메시지: "Product를 찾을 수 없습니다"
영향도: Critical
발생 빈도: 99.96% 요청
```

**원인 분석**:
- 테스트 데이터베이스에 상품 데이터가 존재하지 않음
- `data.sql`로 20개 상품 데이터를 준비했으나 DB 초기화 설정 문제
- `sql.init.mode: always` 설정이 제거되어 데이터 로딩 안됨

#### 4.1.2 Kafka 연결 실패
**문제**: Kafka 브로커 연결 지속적 실패
```
오류 로그: "Connection to node -1 (localhost/127.0.0.1:9092) could not be established"
영향도: High
발생 빈도: 지속적
```

**원인 분석**:
- Kafka 서버가 실행되지 않음
- Docker Compose의 Kafka 컨테이너 상태 불안정
- Spring Kafka 설정과 실제 Kafka 브로커 상태 불일치

#### 4.1.3 Bean 충돌 문제 (해결됨)
**문제**: 중복 Bean 정의로 인한 애플리케이션 시작 실패
```
오류: ConflictingBeanDefinitionException: 'orderEventListener' conflicts
상태: 해결됨
```

**해결 방법**:
- 중복 클래스 제거: `application.order.event.OrderEventListener`
- 중복 클래스 제거: `infra.client.dataplatform.DataPlatformService`

### 4.2 Performance Issues

#### 4.2.1 데이터베이스 설정 최적화 필요
**현재 설정**:
```yaml
spring:
  jpa:
    hibernate:
      ddl-auto: update  # create-drop에서 변경됨
```

**개선 필요 사항**:
- 프로덕션 환경에서는 `ddl-auto: validate` 권장
- 데이터 초기화 전략 재검토 필요

## 5. 개선안 및 대응 방안

### 5.1 즉시 대응 방안 (Critical)

#### 5.1.1 상품 데이터 수동 입력
```sql
-- 테스트용 상품 데이터 직접 DB 삽입
INSERT INTO product (id, name, price, quantity, created_at, updated_at) VALUES
(1, 'Test Product 1', 10000, 1000, NOW(), NOW()),
(2, 'Test Product 2', 20000, 1000, NOW(), NOW()),
(3, 'Test Product 3', 30000, 1000, NOW(), NOW()),
(4, 'Test Product 4', 40000, 1000, NOW(), NOW()),
(5, 'Test Product 5', 50000, 1000, NOW(), NOW());
```

#### 5.1.2 Kafka 서비스 재시작
```bash
# Docker Compose로 Kafka 재시작
docker-compose down
docker-compose up -d kafka
```

### 5.2 단기 개선안 (1-2주)

#### 5.2.1 데이터 초기화 전략 개선
- 테스트 환경용 별도 data.sql 관리
- 환경별 프로파일 분리 (local, test, prod)
- 데이터 시딩 자동화 스크립트 작성

#### 5.2.2 모니터링 강화
- Kafka 연결 상태 헬스체크 추가
- 데이터베이스 연결 풀 모니터링
- 응답 시간별 알림 설정

### 5.3 중장기 개선안 (1-3개월)

#### 5.3.1 부하 테스트 자동화
- CI/CD 파이프라인에 부하 테스트 통합
- 성능 regression 자동 감지
- 부하 테스트 결과 대시보드 구축

#### 5.3.2 시스템 아키텍처 개선
- 상품 조회 API 캐싱 전략 수립
- 데이터베이스 읽기 복제본 도입 고려
- 서킷 브레이커 패턴 적용

## 6. 벤치마크 분석

### 6.1 현재 시스템 성능 기준선
```
기준 메트릭 (Product 데이터 존재 시 예상):
- 목표 TPS: 50 TPS
- 평균 응답시간: < 100ms
- 95th percentile: < 500ms
- 99th percentile: < 1000ms
- 성공률: > 99%
```

### 6.2 성능 목표 설정
```
단기 목표 (1개월):
- TPS: 100 TPS
- 평균 응답시간: < 50ms
- 성공률: 99.9%

중기 목표 (3개월):
- TPS: 500 TPS
- 평균 응답시간: < 30ms
- 성공률: 99.95%
```

## 7. 장애 대응 플레이북

### 7.1 상품 조회 실패 대응
```
1. 즉시 확인 사항:
   - 데이터베이스 연결 상태
   - 상품 테이블 데이터 존재 여부
   - 애플리케이션 로그 확인

2. 복구 절차:
   - 상품 데이터 수동 입력
   - 애플리케이션 재시작
   - 테스트 재실행으로 복구 확인

3. 예방 조치:
   - 데이터 백업 자동화
   - 상품 데이터 최소 임계값 모니터링
```

### 7.2 Kafka 연결 실패 대응
```
1. 즉시 확인 사항:
   - Kafka 컨테이너 상태 확인
   - 네트워크 연결 상태 확인
   - Kafka 브로커 로그 확인

2. 복구 절차:
   - Docker Compose 재시작
   - 포트 충돌 확인 및 해결
   - Spring Kafka 설정 재검토

3. 예방 조치:
   - Kafka 헬스체크 자동화
   - 연결 실패 시 재시도 로직 강화
   - 대체 메시징 시스템 고려
```

## 8. 회고 및 교훈

### 8.1 잘했던 점
- **우수한 응답 시간**: 17ms 평균 응답시간으로 성능 목표 달성
- **체계적인 테스트**: k6를 활용한 구조화된 부하 테스트 구성
- **Bean 충돌 해결**: 체계적인 문제 분석과 신속한 해결

### 8.2 아쉬웠던 점
- **테스트 데이터 준비 부족**: 상품 데이터 부재로 실질적인 테스트 불가
- **인프라 준비 미흡**: Kafka 서버 상태 사전 점검 부족
- **환경 설정 일관성**: 개발/테스트 환경 간 설정 차이

### 8.3 핵심 교훈
1. **테스트 데이터 관리의 중요성**: 실제와 유사한 데이터로 테스트해야 의미있는 결과 도출 가능
2. **인프라 의존성 관리**: 외부 시스템(Kafka, DB) 상태 사전 검증 필수
3. **점진적 부하 증가**: 소규모부터 시작하여 단계적으로 부하 증가 필요
4. **모니터링 우선**: 성능 지표뿐만 아니라 에러율, 인프라 상태 동시 모니터링

### 8.4 다음 단계 액션 아이템
- [ ] 상품 데이터 수동 입력으로 즉시 테스트 재실행
- [ ] Kafka 서버 상태 점검 및 재시작
- [ ] 환경별 설정 파일 분리 및 관리 체계 수립
- [ ] 부하 테스트 자동화 파이프라인 구축 계획 수립
- [ ] 성능 모니터링 대시보드 구축 검토

## 9. 결론

현재 시스템은 **응답 시간 측면에서 우수한 성능**을 보이고 있으나, **데이터 준비와 인프라 안정성** 측면에서 개선이 필요합니다. 

핵심 문제인 상품 데이터 부재 문제를 해결하면 실질적인 부하 테스트가 가능할 것으로 예상되며, 현재의 우수한 응답 시간을 바탕으로 더 높은 TPS 목표 달성이 가능할 것으로 판단됩니다.

체계적인 장애 대응 플레이북과 개선안을 통해 안정적이고 확장 가능한 시스템 구축의 기반을 마련했습니다. 