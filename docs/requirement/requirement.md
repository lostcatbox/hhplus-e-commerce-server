# 요구사항 분석(이찬희님 자료 참조)

## 1. 잔액 충전 / 조회 API

### 1-1. 사용자 식별자 및 충전할 금액을 받아 잔액을 충전합니다.

#### 🔸 기능적 요구사항

1. 사용자 식별자(`userId`)를 기반으로 계정 확인
    * 존재하지 않는 사용자일 경우 예외 발생 (`404 Not Found`)
2. 최소 / 최대 충전 금액 정책
    * 예: 최소 1,000원, 최대 1,000,000원
    * 범위를 벗어난 충전 요청은 `400 Bad Request` 처리
3. 충전 금액은 양수만 가능
    * 음수 값이 입력되면 예외 처리 (`400 Bad Request`)
4. 충전 후 잔액 업데이트
    * 현재 잔액 + 충전 금액 = 새로운 잔액 저장

#### 🔹 비기능적 요구사항

1. 충전 내역 로깅 / 이력 저장
    - 충전 기록을 `ChargeHistory` 테이블 등에 저장 (충전 금액, 일시 등)
2. 환불 정책
    - 충전된 잔액을 사용자가 환불 요청할 수 있는지 여부 결정
3. 트랜잭션 관리
    - 충전 중 오류 발생 시 롤백 필요 (ex: DB 장애, 중복 충전 등)
4. 동시성 처리
    - 잔액 충전 & 결제 동시 요청 시, 정합성 유지 필요

<br>

### 1-2. 사용자 식별자를 통해 해당 사용자의 잔액을 조회합니다.

#### 🔸 기능적 요구사항

1. 사용자 식별자를 통해 해당 사용자의 잔액을 조회
    - 존재하지 않는 사용자일 경우 예외 발생 (`404 Not Found`)
2. 잔액이 없는 경우 `0` 반환
    - 사용자 계정은 있지만 충전된 금액이 없을 경우, `null` 대신 `0`을 반환

#### 🔹 비기능적 요구사항

1. 실시간 데이터 조회
    - 캐싱할지 여부 고민 (고객이 자주 조회하는 경우 성능 최적화 필요)

<br>

## 2. 상품 조회 API

### 2-1. 상품 정보 ( ID, 이름, 가격, 잔여수량 ) 을 조회합니다.

#### 🔸 기능적 요구사항

1. 상품 ID 기반 조회
    - 존재하지 않는 상품이면 404 Not Found 응답
2. 비활성화된 상품 제외
    - 단종되거나 판매 중지된 상품은 조회 불가 (`403 Forbidden`)

#### 🔹 비기능적 요구사항

1. 트랜잭션 관리
    - 주문 시 실시간 재고 업데이트 반영
2. 동시성 처리
    - 주문과 상품 조회 동시 요청 시 정합성 유지
3. 상품 상태 관리
    - 재고가 0인 경우에도 조회 가능하도록 처리할지 여부 결정
    - 단종된 상품은 별도 `DISCONTINUED` 상태로 관리

<br>

## 3. 선착순 쿠폰 기능

### 3-1. 사용자는 선착순으로 쿠폰을 발급받을 수 있어야 합니다.

#### 🔸 기능적 요구사항

1. 쿠폰 재고 관리
    - 쿠폰의 총 발급 가능 수량을 DB에서 관리 (`total_count`)
    - 이미 발급된 쿠폰 개수(`issued_count`)와 비교하여 선착순 체크
    - `issued_count >= total_count`이면 발급 불가 (`409 Conflict`)
2. 중복 발급 제한
    - 한 사용자가 동일 쿠폰을 한 번만 발급 가능
    - 예외 상황: 특정 이벤트에서는 여러 장 허용 가능

#### 🔹 비기능적 요구사항

1. 트랜잭션 처리
    - 쿠폰 발급 시 동시성 문제 방지

<br>

### 3-2. 발급된 쿠폰 목록을 조회할 수 있어야 합니다.

#### 🔸 기능적 요구사항

1. 사용자 식별자 기반 조회 (`userId`)
    - 본인 쿠폰만 조회 가능, 다른 사용자 쿠폰 조회 차단 (`403 Forbidden`)
2. 쿠폰 상태 포함 (`미사용 / 사용 완료 / 만료`)
    - 미사용 쿠폰만 보여줄지 여부 옵션 제공
    - 만료된 쿠폰 필터링 가능

#### 🔹 비기능적 요구사항

1. 페이징 지원
    - 한 번에 너무 많은 쿠폰을 불러오는 경우 대비
    - `limit`, `offset` 또는 `cursor 기반 페이지네이션` 적용

<br>

### 3-3. 주문 시 유효한 쿠폰을 제출하면 전체 주문 금액에 대해 할인이 적용되어야 합니다.

#### 🔸 기능적 요구사항

1. 유효한 쿠폰인지 검증
    - 쿠폰이 사용되지 않았는지 (`status == unused`) 확인
    - 쿠폰 유효기간 체크
2. 쿠폰 사용 시 할인 적용 방식
    - 전체 주문 금액에서 쿠폰 할인 금액 차감
    - 예: `총 금액 50,000원 - 쿠폰 할인 5,000원 = 최종 결제 금액 45,000원`
3. 쿠폰 상태 변경
    - 주문 확정 시 `used` 상태로 업데이트
    - 결제 실패 시 쿠폰 상태 롤백 처리 필요
4. 쿠폰이 없는 경우에도 주문 가능

<br>

## 4. 주문 / 결제 API

### 4-1. 사용자는 (상품 ID, 수량) 목록을 입력하여 주문할 수 있어야 합니다.

#### 🔸 기능적 요구사항

1. 사용자 인증 및 검증
    - `userId`를 이용해 사용자 정보 조회
    - 비정상 사용자 (정지 계정, 탈퇴 계정) 주문 제한
2. 상품별 주문 가능 여부 확인
    - 요청한 상품 목록 `(상품 ID, 수량)`을 하나씩 확인
    - 각 상품의 재고 확인 (`stock >= quantity`)
    - 재고 부족 시 해당 상품은 주문 불가 (예외 처리 또는 부분 주문 가능)
3. 총 주문 금액 계산
    - 각 상품의 가격을 조회 후 `(상품 가격 × 수량)`으로 총 주문 금액 산출
    - 유효한 쿠폰이 있다면 할인 적용
4. 주문 취소 정책
    - 주문 확정 후 일정 시간 이내 취소 가능
    - 결제 완료 후 일정 기간 지나면 취소 불가

#### 🔹 비기능적 요구사항

1. 주문 단위 정책
    - 하나의 주문에서 여러 상품 구매 가능
    - 주문 실패 시 전체 롤백 또는 부분 주문 가능 여부 결정
2. 상품 구매 제한 정책
    - 특정 상품에 대해 1인당 최대 구매 수량 제한 가능
    - 한정 수량 상품의 경우 선착순 정책 필요

<br>

### 4-2. 주문 시 결제는 기존에 충전된 잔액을 사용하여 수행합니다. 결제 성공 시 잔액이 차감되어야 합니다.

#### 🔸 기능적 요구사항

1. 사용자의 잔액 확인
    - `포인트 도메인`에서 사용자 잔액 조회
    - `총 주문 금액 <= 사용자 잔액`인지 확인
    - 잔액 부족 시 결제 실패 (`409 Conflict`)
2. 잔액 차감 및 주문 확정
    - 결제 승인 시, `포인트 도메인`에 잔액 차감 요청

#### 🔹 비기능적 요구사항

1. 결제 동시성 문제 방지
    - 동일 사용자가 동일한 주문을 여러 번 결제하는 경우 차단 필요
    - 트랜잭션 처리 (결제 성공 시 주문 확정 & 잔액 차감 동시 수행)

<br>

### 4-3. 결제 성공 시 주문 정보를 외부 데이터 플랫폼으로 전송합니다.

#### 🔸 기능적 요구사항

1. 실시간 데이터 플랫폼 전송
    - 결제 성공 후 외부 데이터 플랫폼으로 주문 정보 전송

#### 🔹 비기능적 요구사항

1. 비동기 방식 전송 고려
    - 실시간 요청 부하를 줄이기 위해 Kafka, RabbitMQ 같은 메시지 큐 활용 가능

<br>

## 5. 상위 상품 조회 API

### 5-1. 최근 3일간 가장 많이 팔린 상위 5개 상품 정보를 제공합니다.

#### 🔸 기능적 요구사항

1. 기간 내 주문 데이터 집계
    - 최근 3일간 결제 완료된 주문에서 판매된 상품 데이터 집계
2. 최상위 5개 상품 조회
    - 동률 발생 시 상품 ID 기준 추가 정렬 가능
3. 실시간 조회 vs 사전 집계
    - 실시간 쿼리 방식은 부하 발생 위험 → 통계 테이블 활용
    - 배치 작업을 통해 별도 집계 테이블 유지
4. 배치 데이터 갱신 주기
    - 매일 자정에 집계 실행 (`CRON: 0 0 * * *`)