# 결제

**결제에 사용될 금액을 충전 API 를 작성**

- 기능적 요구사항
    - 유저를 유효한 유저인지 확인한다
    - 유저의 충전 금액을 확인하고, 충전한다.
    - 최소값 1000원 ~100만원 이하로 충전되어야함
    - 충전 금액은 양수만 가능하다
    - 충전후 잔액 = 현재 잔액 + 충전 금액
- 비기능적 요구사항
    - 충전 기록
        - ChargeHistory 테이블 등에 저장 (충전 금액, 일시 등)
    - 환불 정책
        - 충전된 금액 사용자가 환불 요청가능한지 여부
    - 동시성 처리
        - 동시에 충전 및 사용 요청시 원자성 고려

**결제에 사용될 금액을 조회 API**

- 기능적 요구사항
    - userId를 기반으로 유저를 유효한 유저인지 확인
        - 존재하지않을 경우, 404 Not Found 발생
    - 잔액이 없는 경우 `0`을 반환
        - 사용자 계정이 있지만 충전된 금액이 없을 경우, `null` 대신 `0` 을 반환
- 비기능적
    - 실시간 데이터 조회
        - 캐싱할지 여부 고민 -> 고객이 자주 조회시 성능 최적화 필요

# 상품

**상품 리스트 조회 API**

- 기능적 요구사항
    - 상품 조회 시점에 잔고조회
        - 존재하지 않는 상품 조회시 404에러
    - 비활성화된 상품 제외
        - 단종되거나 판매 중지된 상품 조회 불가(403)
- 비기능적 요구사항
    - 트랜잭션 관리
        - 주문 시 실시간 재고 업데이트 반영
    - 동시성 처리
        - 주문과 상품 조회 동시 요청시 정합성 유지
    - 상품 상태 관리
        - 재고가 0인 경우에도 조회가능하도록 처리하기

# 선착순 쿠폰

사용자는 선착순으로 쿠폰을 발급받습니다

- 기능적 요구사항
    - 쿠폰 재고 관리
        - 쿠폰의 총 발급 가능 수량은 DB에서 관리('total_count')
        - 이미 발급된 쿠폰 개수('issued_count')와 비교하여 선착순 체크
        - `issued_count >= total_count`이면 발급 불가 (`409 Conflict`)
    - 중복 발급 제한
        - 한 사용자가 동일 쿠폰을 한 번만 발급 가능
            - 예외 상황: 특정 이벤트에서는 여러 장 허용 가능
- 비기능적 요구사항
    - 트랜잭션 처리
        - 쿠폰 발급 시 동시성 문제 방지

발급된 쿠폰 목록 조회

- 기능적 요구사항
    - userid를 기반 조회
        - 본인 쿠폰만 조회 가능
        - 다른 사용자 쿠폰 조회 차단(403)
    - 쿠폰 상태 포함(미사용, 사용완료, 만료)
- 비기능적 요구사항
    - 페이징 지원
        - 한번에 너무 많은 쿠폰 불러오는 경우 대비
        - limit, offset, cursor기반 페이지 네이션

주문 시 유효한 쿠폰을 제출하면 전체 주문에 대해 할인 적용

- 기능적 요구사항
    - 유효한 쿠폰 인지 확인
        - 유효기간 체크
        - 쿠폰 미사용 쿠폰 상태 체크
    - 쿠폰 사용시 할인 방식 적용
        - 전체 주문 금액에서 쿠폰 할인 금액 차감
        - 예`총 금액 50,000원 - 쿠폰 할인 5,000원 = 최종 결제 금액 45,000원`
    - 쿠폰 상태 변경
        - 주문 확정 시 used 상태로 업데이트
        - 결제 실패 시 쿠폰 상태 롤백 처리 필요
    - 쿠폰이 없는 경우도 주문가능

# 주문

사용자는 (상품 ID, 수량) 목록을 입력하여 주문할 수 있어야합니다.

- 기능적 요구사항
    - 사용자 인증 및 검증
    - 상품별 주문 가능 여부 확인
        - 요청한 상품 목록 상품 ID로 상품 조회
        - 각 상품의 재고 확인
        - 재고 부족시 해당 상품은 주문 불가 (예외 처리)
    - 총 주문 금액 계산
        - 각 상품의 가격을 조회 후 `상품 가격 * 수량` 으로 총 주문 금액 산출
        - 유효한 쿠폰이 있다면 할인 적용
    - 주문 취소 정책
        - 주문 확정 후 일정 시간 이내 취소 가능
- 비기능적 요구사항
    - 주문 단위 정책
        - 하나의 주문에서 여러 상품 구매가능
        - 주문 실패시 전체 롤백

**주문 시 결제는 기존에 충전된 잔액을 사용하여 수행합니다. 결제 성공 시 잔액이 차감되어야 합니다.**

- 기능적 요구사항
    - 사용자의 잔액 확인
        - `포인트` 에서 사용자 잔액 조회
        - 주문 시 결제 필요 금액 <= 충전 잔액 확인
        - 잔액 부족시 결제 실패(409)
    - 잔액 차감 및 주문 확정
        - 결제 승인 시, `포인트`에 잔액 차감 요청
- 비기능적 요구사항
    - 결제 동시성 문제 발생
        - 동일 사용자가 주문을 여러번 결제하는 경우 차단 필요
        - 트랜잭션 처리(결제 성공 시 주문 확정 및 잔액 차감 동시 수행)

결제 성공 시 주문 정보를 외부 데이터 플랫폼으로 전송합니다.

- 기능적 요구사항
    - 실시간 데이터 플랫폼 전송
        - 결제 성공 후 외부 데이터 플랫폼으로 주문 정보 전송
- 비기능적 요구사항
    - 비동기 방식 전송 고려
        - 실시간 요청 부하를 줄이기 위해 Kafka, RabbitMQ 같은 메시지 큐 활용 가능

# 상위 상품 조회 API

최근 3일간 가장 많이 팔린 상위 5개 상품 정보를 제공하빈다

- 기능적 요구사항
    - 기간 내 주문 데이터 집계
        - 최근 3일간 결제 완료된 주문에서 판매된 상품 데이터 집계
            - 주문 완료 처리완료 시 -> 이벤트로 상품 집계 -> productId 조회 후 count-=1
            - 주문 취소 처리완료 시 -> 이벤트로 상품 집계 -> productId 조회 후 count-=1
    - 최상위 5개 상품 조회
    - (추가 고려) 시간 조회 vs 사전 집계
    - (추가 고려) 배치로 주문 데이터 "결제완료"포함 이후 주문 상태 데이터를 3일치를 productId로 주문 합계 count
        - 주문량이 매우많아지면, 매일 주문량이 몇천만건이 된다면, 모두 쿼리 및 집계할수없다. 그래서 배치+쿼리로 갱신하지않고, 주문된 시점에 이벤트 발생시켜서 count하는게 더 나아보인다.
        - 최근 3일간이므로, 00시에 4일치의 주문량은 TopSaleData에서 삭제한다.

# 과제 기존 요구사항

1️⃣ **`주요`** **잔액 충전 / 조회 API**

- 결제에 사용될 금액을 충전하는 API 를 작성합니다.
- 사용자 식별자 및 충전할 금액을 받아 잔액을 충전합니다.
- 사용자 식별자를 통해 해당 사용자의 잔액을 조회합니다.

2️⃣ **`기본` 상품 조회 API**

- 상품 정보 ( ID, 이름, 가격, 잔여수량 ) 을 조회하는 API 를 작성합니다.
- 조회시점의 상품별 잔여수량이 정확하면 좋습니다.

3️⃣ **`주요` 선착순 쿠폰 기능**

- 선착순 쿠폰 발급 API 및 보유 쿠폰 목록 조회 API 를 작성합니다.
- 사용자는 선착순으로 할인 쿠폰을 발급받을 수 있습니다.
- 주문 시에 유효한 할인 쿠폰을 함께 제출하면, 전체 주문금액에 대해 할인 혜택을 부여받을 수 있습니다.

4️⃣ **`주요`** **주문 / 결제 API**

- 사용자 식별자와 (상품 ID, 수량) 목록을 입력받아 주문하고 결제를 수행하는 API 를 작성합니다.
- 결제는 기 충전된 잔액을 기반으로 수행하며 성공할 시 잔액을 차감해야 합니다.
- 데이터 분석을 위해 결제 성공 시에 실시간으로 주문 정보를 데이터 플랫폼에 전송해야 합니다. ( 데이터 플랫폼이 어플리케이션 `외부` 라는 가정만 지켜 작업해 주시면 됩니다 )

> 데이터 플랫폼으로의 전송 기능은 Mock API, Fake Module 등 다양한 방법으로 접근해 봅니다.

5️⃣  **`기본` 상위 상품 조회 API**

- 최근 3일간 가장 많이 팔린 상위 5개 상품 정보를 제공하는 API 를 작성합니다.
- 통계 정보를 다루기 위한 기술적 고민을 충분히 해보도록 합니다.